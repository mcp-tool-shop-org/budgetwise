<Page
    x:Class="BudgetWise.App.Views.BudgetPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">

    <Grid Padding="24" RowDefinitions="Auto,Auto,Auto,Auto,Auto,*" RowSpacing="12" MaxWidth="1200" HorizontalAlignment="Left">
        <!-- Page Header -->
        <StackPanel Orientation="Horizontal" Spacing="12">
            <TextBlock Text="Budget" FontSize="28" FontWeight="SemiBold" />
            <TextBlock Text="{Binding YearMonthText}" FontSize="14" Opacity="0.6" VerticalAlignment="Bottom" Margin="0,0,0,4" />
        </StackPanel>

        <!-- Primary Metric: Ready to Assign (visually dominant) -->
        <Border Grid.Row="1" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                CornerRadius="8" Padding="16,12" HorizontalAlignment="Left">
            <StackPanel Orientation="Horizontal" Spacing="16">
                <StackPanel>
                    <TextBlock Text="Ready to Assign" FontSize="13" Opacity="0.7" />
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="{Binding ReadyToAssignText}"
                                   FontSize="28"
                                   FontWeight="Bold"
                                   Foreground="{Binding IsOverbudgeted, Converter={StaticResource OverspentToBrushConverter}}"
                                   ToolTipService.ToolTip="Money available to budget for this month (income minus what you've assigned so far)." />
                        <FontIcon Glyph="&#xE7BA;" FontSize="16" Foreground="Tomato" VerticalAlignment="Center"
                                  Visibility="{Binding IsOverbudgeted, Converter={StaticResource BoolToVisibilityConverter}}"
                                  ToolTipService.ToolTip="You've assigned more than you have!" />
                    </StackPanel>
                </StackPanel>

                <!-- Auto-Assign with contextual hint -->
                <StackPanel VerticalAlignment="Center" Spacing="4">
                    <TextBlock Text="{Binding GoalsFundableHint}" FontSize="12" Opacity="0.7"
                               Visibility="{Binding HasGoalsToFund, Converter={StaticResource BoolToVisibilityConverter}}" />
                    <Button Content="Auto-Assign To Goals"
                            Command="{Binding AutoAssignToGoalsCommand}"
                            Style="{StaticResource AccentButtonStyle}"
                            ToolTipService.ToolTip="Automatically distribute Ready to Assign toward envelopes with goals." />
                </StackPanel>
            </StackPanel>
        </Border>

        <!-- Instructions -->
        <TextBlock Grid.Row="2"
                   Text="Click the Assigned column to budget money. Enter to save, Esc to cancel."
                   FontSize="13" Opacity="0.6" />

        <!-- Overbudget Warning -->
        <InfoBar Grid.Row="3"
                 IsOpen="{Binding IsOverbudgeted}"
                 IsClosable="False"
                 Severity="Warning"
                 Title="Overbudgeted"
                 Message="You've assigned more money than you have available. Reduce allocations or add income." />

        <!-- Loading / Error States -->
        <StackPanel Grid.Row="4" Spacing="8">
            <ProgressBar IsIndeterminate="True" Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibilityConverter}}" />

            <TextBlock Text="{Binding ErrorText}"
                       Foreground="Tomato"
                       TextWrapping="Wrap"
                       Visibility="{Binding HasError, Converter={StaticResource BoolToVisibilityConverter}}" />

            <InfoBar IsOpen="{Binding ShowEmptyState}"
                    IsClosable="False"
                    Severity="Informational"
                    Title="No budget categories yet"
                    Message="Starter envelopes will appear automatically on first launch. If this still shows, restart the app or open Diagnostics." />
        </StackPanel>

        <!-- Envelope List -->
        <StackPanel Grid.Row="5" Spacing="4">
            <!-- Column Headers -->
            <Grid ColumnDefinitions="*,110,130,100,100" ColumnSpacing="8" Padding="12,8" Opacity="0.7"
                  Visibility="{Binding HasEnvelopes, Converter={StaticResource BoolToVisibilityConverter}}">
                <TextBlock Text="Envelope" FontWeight="SemiBold" FontSize="12"
                           ToolTipService.ToolTip="Categories for your spending. Each envelope holds money for a specific purpose." />
                <TextBlock Grid.Column="1" Text="Assigned" FontWeight="SemiBold" FontSize="12" HorizontalAlignment="Right"
                           ToolTipService.ToolTip="How much you've budgeted this month. Click to edit." />
                <TextBlock Grid.Column="2" Text="Available" FontWeight="SemiBold" FontSize="12" HorizontalAlignment="Right"
                           ToolTipService.ToolTip="What's left to spend (Assigned minus Spent). Negative = overspent." />
                <TextBlock Grid.Column="3" Text="Goal" FontWeight="SemiBold" FontSize="12" HorizontalAlignment="Right"
                           ToolTipService.ToolTip="Target amount you want in this envelope." />
                <TextBlock Grid.Column="4" Text="Target" FontWeight="SemiBold" FontSize="12" HorizontalAlignment="Right"
                           ToolTipService.ToolTip="When you want to reach your goal." />
            </Grid>

            <ListView ItemsSource="{Binding EnvelopeRows}"
                      SelectionMode="None">
                <ListView.ItemContainerStyle>
                    <Style TargetType="ListViewItem">
                        <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                        <Setter Property="Padding" Value="0" />
                        <Setter Property="Margin" Value="0,1" />
                    </Style>
                </ListView.ItemContainerStyle>
                <ListView.ItemTemplate>
                    <DataTemplate>
                        <Grid ColumnDefinitions="*,110,130,100,100" ColumnSpacing="8" Padding="12,8"
                              Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}"
                              CornerRadius="6"
                              PointerEntered="EnvelopeRow_PointerEntered"
                              PointerExited="EnvelopeRow_PointerExited">
                            <!-- Envelope Name + Group -->
                            <StackPanel VerticalAlignment="Center" Spacing="2">
                                <TextBlock Text="{Binding Name}" FontWeight="SemiBold" />
                                <TextBlock Text="{Binding GroupName}" FontSize="11" Opacity="0.5"
                                           Visibility="{Binding GroupName, Converter={StaticResource StringToVisibilityConverter}}" />
                            </StackPanel>

                            <!-- Assigned (Editable) with edit icon hint -->
                            <Grid Grid.Column="1" HorizontalAlignment="Right" VerticalAlignment="Center">
                                <TextBox Text="{Binding AssignedText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                         HorizontalAlignment="Stretch"
                                         TextAlignment="Right"
                                         MinWidth="90"
                                         Padding="8,4"
                                         BorderThickness="1"
                                         CornerRadius="4"
                                         AutomationProperties.Name="Assigned amount"
                                         ToolTipService.ToolTip="Enter amount to assign. Press Enter to save."
                                         KeyDown="AllocationTextBox_KeyDown"
                                         LostFocus="AllocationTextBox_LostFocus" />
                            </Grid>

                            <!-- Available with overspend indicator and action -->
                            <StackPanel Grid.Column="2" HorizontalAlignment="Right" VerticalAlignment="Center" Spacing="4">
                                <StackPanel Orientation="Horizontal" Spacing="4" HorizontalAlignment="Right">
                                    <TextBlock Text="{Binding AvailableText}"
                                               Foreground="{Binding IsOverspent, Converter={StaticResource OverspentToBrushConverter}}"
                                               FontWeight="SemiBold" />
                                    <FontIcon Glyph="&#xE7BA;" FontSize="12" Foreground="Tomato"
                                              Visibility="{Binding IsOverspent, Converter={StaticResource BoolToVisibilityConverter}}"
                                              ToolTipService.ToolTip="Overspent!" />
                                </StackPanel>
                                <!-- Overspend magnitude hint -->
                                <TextBlock Text="{Binding OverspentHint}" FontSize="10" Foreground="Tomato"
                                           HorizontalAlignment="Right"
                                           Visibility="{Binding IsOverspent, Converter={StaticResource BoolToVisibilityConverter}}" />
                            </StackPanel>

                            <!-- Goal -->
                            <TextBlock Grid.Column="3" Text="{Binding GoalAmountText}" HorizontalAlignment="Right" VerticalAlignment="Center" Opacity="0.7" FontSize="13" />

                            <!-- Target Date -->
                            <TextBlock Grid.Column="4" Text="{Binding GoalDateText}" HorizontalAlignment="Right" VerticalAlignment="Center" Opacity="0.7" FontSize="13" />
                        </Grid>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>
        </StackPanel>
    </Grid>
</Page>
