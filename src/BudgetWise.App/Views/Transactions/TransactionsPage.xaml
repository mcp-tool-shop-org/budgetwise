<Page
    x:Class="BudgetWise.App.Views.Transactions.TransactionsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">

    <Grid Padding="24" RowDefinitions="Auto,Auto,Auto,*" RowSpacing="12" MaxWidth="1200" HorizontalAlignment="Left">
        <TextBlock Text="Transactions" FontSize="28" FontWeight="SemiBold" />

        <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="8">
            <ComboBox Width="260"
                      ItemsSource="{Binding Accounts}"
                      SelectedItem="{Binding SelectedAccount, Mode=TwoWay}"
                      DisplayMemberPath="Name"
                      PlaceholderText="Select account"
                      AutomationProperties.Name="Account" />

            <Button Content="Refresh" Command="{Binding RefreshCommand}" />

                <Button Content="Toggle cleared"
                    Command="{Binding ToggleClearedCommand}"
                    IsEnabled="{Binding HasSelectedTransaction}"
                    ToolTipService.ToolTip="Marks the selected transaction as cleared or uncleared." />
        </StackPanel>

        <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="8">
            <TextBox Width="220" PlaceholderText="Payee" Text="{Binding NewPayee, Mode=TwoWay}"
                     AutomationProperties.Name="Payee" />
            <TextBox Width="120" PlaceholderText="Amount" Text="{Binding NewAmount, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                     AutomationProperties.Name="Amount" />
            <CheckBox Content="Inflow" IsChecked="{Binding NewIsInflow, Mode=TwoWay}" />

            <CheckBox Content="Split"
                      IsChecked="{Binding NewIsSplit, Mode=TwoWay}"
                      Visibility="{Binding IsOutflowEntry, Converter={StaticResource BoolToVisibilityConverter}}" />

            <ComboBox Width="240"
                      ItemsSource="{Binding Envelopes}"
                      SelectedItem="{Binding SelectedEnvelope, Mode=TwoWay}"
                      DisplayMemberPath="Name"
                      PlaceholderText="Envelope (outflow)"
                      AutomationProperties.Name="Envelope"
                      Visibility="{Binding IsOutflowEntry, Converter={StaticResource BoolToVisibilityConverter}}" />

            <Button Content="Add" Command="{Binding AddTransactionCommand}" IsEnabled="{Binding CanAddTransaction}" />
        </StackPanel>

        <StackPanel Grid.Row="3" Spacing="8">
            <StackPanel Orientation="Horizontal" Spacing="8"
                        Visibility="{Binding NewIsSplit, Converter={StaticResource BoolToVisibilityConverter}}">
                <Button Content="Add split line" Command="{Binding AddSplitLineCommand}" />
                <Button Content="Remove last" Command="{Binding RemoveLastSplitLineCommand}" />
                <TextBlock Text="Split lines" VerticalAlignment="Center" />
                <TextBlock Text="{Binding SplitSummaryText}"
                           VerticalAlignment="Center"
                           Opacity="0.8"
                           TextWrapping="NoWrap" />
            </StackPanel>

            <ListView ItemsSource="{Binding SplitLines}"
                      Visibility="{Binding NewIsSplit, Converter={StaticResource BoolToVisibilityConverter}}">
                <ListView.ItemTemplate>
                    <DataTemplate>
                        <Grid ColumnDefinitions="260,120" ColumnSpacing="8" Padding="2">
                            <ComboBox ItemsSource="{Binding AvailableEnvelopes}"
                                      SelectedItem="{Binding Envelope, Mode=TwoWay}"
                                      DisplayMemberPath="Name"
                                      PlaceholderText="Envelope"
                                      AutomationProperties.Name="Split line envelope" />
                            <TextBox Grid.Column="1" PlaceholderText="Amount" Text="{Binding Amount, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                     AutomationProperties.Name="Split line amount" />
                        </Grid>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>

            <ProgressBar IsIndeterminate="True" Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibilityConverter}}" />

            <TextBlock Text="{Binding ErrorText}" Foreground="Tomato" TextWrapping="Wrap"
                       Visibility="{Binding ErrorText, Converter={StaticResource StringToVisibilityConverter}}" />

                <InfoBar IsOpen="True"
                    IsClosable="False"
                    Severity="Informational"
                    Title="No transactions in this period"
                    Message="Add a transaction above, or import a CSV to get started."
                    Visibility="{Binding Transactions, Converter={StaticResource CollectionEmptyToVisibilityConverter}}" />

            <Grid ColumnDefinitions="110,*,160,130,70" ColumnSpacing="12" Padding="4" Opacity="0.8"
                  Visibility="{Binding Transactions, Converter={StaticResource CollectionNotEmptyToVisibilityConverter}}">
                <TextBlock Text="Date" FontWeight="SemiBold" />
                <TextBlock Grid.Column="1" Text="Payee" FontWeight="SemiBold" />
                <TextBlock Grid.Column="2" Text="Envelope" FontWeight="SemiBold" />
                <TextBlock Grid.Column="3" Text="Amount" FontWeight="SemiBold" HorizontalAlignment="Right" />
                <TextBlock Grid.Column="4" Text="Status" FontWeight="SemiBold" HorizontalAlignment="Center" ToolTipService.ToolTip="Cleared / Reconciled / Split / Transfer" />
            </Grid>

            <ListView ItemsSource="{Binding Transactions}"
                      SelectionMode="Single"
                      SelectedItem="{Binding SelectedTransaction, Mode=TwoWay}">
                <ListView.ItemTemplate>
                    <DataTemplate>
                        <Grid ColumnDefinitions="110,*,160,130,70" ColumnSpacing="12" Padding="4">
                            <TextBlock Text="{Binding Date, Converter={StaticResource DateOnlyToIsoStringConverter}}" FontFamily="Consolas" />
                            <!-- Payee with type indicators -->
                            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="6">
                                <TextBlock Text="{Binding Payee}" TextTrimming="CharacterEllipsis" VerticalAlignment="Center" />
                                <!-- Split badge -->
                                <Border Background="{ThemeResource AccentFillColorDefaultBrush}" CornerRadius="3" Padding="4,1"
                                        Visibility="{Binding HasSplits, Converter={StaticResource BoolToVisibilityConverter}}"
                                        ToolTipService.ToolTip="Split transaction (multiple envelopes)">
                                    <TextBlock Text="SPLIT" FontSize="10" FontWeight="SemiBold" Foreground="White" />
                                </Border>
                                <!-- Transfer icon -->
                                <FontIcon Glyph="&#xE8AB;" FontSize="12" Opacity="0.7"
                                          Visibility="{Binding IsTransfer, Converter={StaticResource BoolToVisibilityConverter}}"
                                          ToolTipService.ToolTip="Transfer between accounts" />
                            </StackPanel>
                            <TextBlock Grid.Column="2" Text="{Binding EnvelopeName}" TextTrimming="CharacterEllipsis" />
                            <TextBlock Grid.Column="3" Text="{Binding Amount, Converter={StaticResource MoneyToFormattedStringConverter}}" HorizontalAlignment="Right" />
                            <!-- Status icons: Cleared, Reconciled -->
                            <StackPanel Grid.Column="4" Orientation="Horizontal" Spacing="4" HorizontalAlignment="Center">
                                <SymbolIcon Symbol="Accept" Opacity="0.7"
                                            Visibility="{Binding IsCleared, Converter={StaticResource BoolToVisibilityConverter}}"
                                            ToolTipService.ToolTip="Cleared"
                                            AutomationProperties.Name="Cleared" />
                                <FontIcon Glyph="&#xE72E;" FontSize="14" Opacity="0.7"
                                          Visibility="{Binding IsReconciled, Converter={StaticResource BoolToVisibilityConverter}}"
                                          ToolTipService.ToolTip="Reconciled (locked)"
                                          AutomationProperties.Name="Reconciled" />
                            </StackPanel>
                        </Grid>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>

            <StackPanel Spacing="8"
                        Visibility="{Binding IsEditingSelectedSplits, Converter={StaticResource BoolToVisibilityConverter}}">
                <TextBlock Text="Edit selected split" FontWeight="SemiBold" />
                <TextBlock Text="{Binding SelectedSplitSummaryText}" Opacity="0.8" />

                <StackPanel Orientation="Horizontal" Spacing="8">
                    <DatePicker Header="Date"
                                Date="{Binding SelectedEditDate, Mode=TwoWay}" />
                    <TextBox Header="Payee"
                             Width="260"
                             Text="{Binding SelectedEditPayee, Mode=TwoWay}" />
                    <TextBox Header="Memo"
                             Width="340"
                             Text="{Binding SelectedEditMemo, Mode=TwoWay}" />
                </StackPanel>

                <StackPanel Orientation="Horizontal" Spacing="8">
                    <Button Content="Add line" Command="{Binding AddSelectedSplitLineCommand}" />
                    <Button Content="Remove last" Command="{Binding RemoveLastSelectedSplitLineCommand}" />
                    <Button Content="Save" Command="{Binding SaveSelectedSplitsCommand}" IsEnabled="{Binding CanSaveSelectedSplits}" />
                </StackPanel>

                <ListView ItemsSource="{Binding SelectedSplitLines}">
                    <ListView.ItemTemplate>
                        <DataTemplate>
                            <Grid ColumnDefinitions="260,120" ColumnSpacing="8" Padding="2">
                                <ComboBox ItemsSource="{Binding AvailableEnvelopes}"
                                          SelectedItem="{Binding Envelope, Mode=TwoWay}"
                                          DisplayMemberPath="Name"
                                          PlaceholderText="Envelope"
                                          AutomationProperties.Name="Split line envelope" />
                                <TextBox Grid.Column="1" PlaceholderText="Amount" Text="{Binding Amount, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                         AutomationProperties.Name="Split line amount" />
                            </Grid>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>
            </StackPanel>
        </StackPanel>
    </Grid>
</Page>
